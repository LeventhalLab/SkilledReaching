% script_manually_assign_endPtFrame

% script to manually assign reach end point frames when the algorithm fails

labeledBodypartsFolder = '/Volumes/Tbolt_02/Skilled Reaching/DLC output';
% shouldn't need this - calibration should be included in the pawTrajectory
% files
% calImageDir = '/Volumes/Tbolt_02/Skilled Reaching/calibration_images';

xlDir = '/Users/dan/Box Sync/Leventhal Lab/Skilled Reaching Project/Scoring Sheets';
xlfname = fullfile(xlDir,'rat_info_pawtracking_DL.xlsx');
csvfname = fullfile(xlDir,'rat_info_pawtracking_20190708.csv');
ratInfo = readRatInfoTable(csvfname);

vidRootPath = fullfile('/Volumes','Tbolt_01','Skilled Reaching');

ratInfo_IDs = [ratInfo.ratID];

cd(labeledBodypartsFolder)
ratFolders = dir('R*');
numRatFolders = length(ratFolders);

for i_rat = 3:3%numRatFolders

    ratID = ratFolders(i_rat).name;
    ratIDnum = str2double(ratID(2:end));
    ratVidPath = fullfile(vidRootPath,ratID);   % root path for the original videos
    
    ratInfo_idx = find(ratInfo_IDs == ratIDnum);
    if isempty(ratInfo_idx)
        error('no entry in ratInfo structure for rat %d\n',C{1});
    end
    thisRatInfo = ratInfo(ratInfo_idx,:);
    pawPref = thisRatInfo.pawPref;
    if iscategorical(pawPref)
        pawPref = char(pawPref);
    end
    if iscell(pawPref)
        pawPref = pawPref{1};
    end
    
    if any(ratIDs_with_new_date_format == ratIDnum)
        csvDateFormat = 'yyyyMMdd';
    end
    ratRootFolder = fullfile(labeledBodypartsFolder,ratID);
    reachScoresFile = [ratID '_scores.csv'];
    reachScoresFile = fullfile(ratRootFolder,reachScoresFile);
    reachScores = readReachScores(reachScoresFile,'csvdateformat',csvDateFormat);
    allSessionDates = [reachScores.date]';
    
    numTableSessions = length(reachScores);
    dateNums_from_scores_table = zeros(numTableSessions,1);
    for iSession = 1 : numTableSessions
        dateNums_from_scores_table(iSession) = datenum(reachScores(iSession).date);
%         dateNums_from_scores_table(iSession) = datenum(reachScores(iSession).date,'mm/dd/yy');
    end
        
    cd(ratRootFolder);
    sessionDirectories = listFolders([ratID '_2*']);
    numSessions = length(sessionDirectories);
    
    sessionType = determineSessionType(thisRatInfo, allSessionDates);
    
    switch ratID
        case 'R0158'
            startSession = 8;
            endSession = 8;
        case 'R0159'
            startSession = 10;
            endSession = numSessions;
        case 'R0160'
            startSession = 6;
            endSession = numSessions;
        case 'R0217'
            startSession = 33;
            endSession = 33;
        otherwise
            startSession = 1;
            endSession = numSessions;
    end
    for iSession = startSession : 1 : endSession
        
        C = textscan(sessionDirectories{iSession},[ratID '_%8c']);
        sessionDateString = C{1};
        sessionDate = datetime(sessionDateString,'inputformat','yyyyMMdd');
        sessionDates{iSession} = sessionDate;
        
        allSessionIdx = find(sessionDate == allSessionDates);
        
        fullSessionDir = fullfile(ratRootFolder,sessionDirectories{iSession});
        cd(fullSessionDir);
        
        sessionSummaryName = [ratID '_' sessionDateString '_kinematicsSummary.mat'];
             
        try
            load(sessionSummaryName);
        catch
            fprintf('no session summary found for %s\n', sessionDirectories{iSession});
            continue
        end
        
        vidDirectory = fullfile(ratVidPath,sessionDirectories{iSession});
        
        trialNumbers_nanEndPtFrame = trialNumbers(isnan(all_endPtFrame),:);
        trialIdx_nanEndPtFrame = find(trialNumbers(isnan(all_endPtFrame),:));
        
        if isempty(trialNumbers_nanEndPtFrame)
            continue;
        end
        
        isEndPtManuallyMarked = false(size(trialNumbers,1),1);
        for i_missedTrial = 1 : size(trialNumbers_nanEndPtFrame,1)
            curTrialNums = trialNumbers_nanEndPtFrame(i_missedTrial,:);
            sprintf('reach end points for session %s, trial %d, label %d\n',sessionDateString, curTrialNums(1),curTrialNums(2));
            
            q = squeeze(allTrajectories(:,3,10:11,trialIdx_nanEndPtFrame(i_missedTrial)));
            h_dig2z = figure(1);
            plot(q(:,1));
            set(gcf,'name','second digit');
            
            h_dig3z = figure(2);
            plot(q(:,2));
            set(gcf,'name','third digit');
            
            dig2_endFrames = input('reach endpoint frames for digit 2: ');
            dig3_endFrames = input('reach endpoint frames for digit 3: ');
            
            if isempty(dig2_endFrames) && isempty(dig3_endFrames)
                continue
            elseif isempty(dig2_endFrames)
                endPtFrame = dig3_endFrames(1);
                final_endPtFrame = dig3_endFrames(end);
            elseif isempty(dig3_endFrames)
                endPtFrame = dig2_endFrames(1);
                final_endPtFrame = dig3_endFrames(2);
            else
                endPtFrame = max(dig2_endFrames(1),dig3_endFrames(1));
                final_endPtFrame = max(dig2_endFrames(end),dig3_endFrames(end));
            end
            isEndPtManuallyMarked(trialIdx_nanEndPtFrame(i_missedTrial)) = true;
            all_endPtFrame(trialIdx_nanEndPtFrame(i_missedTrial)) = endPtFrame;
            all_final_endPtFrame(trialIdx_nanEndPtFrame(i_missedTrial)) = final_endPtFrame;
            
            all_reachFrameIdx{trialIdx_nanEndPtFrame(i_missedTrial)}{10} = dig2_endFrames;
            all_reachFrameIdx{trialIdx_nanEndPtFrame(i_missedTrial)}{11} = dig3_endFrames;
            
            save(sessionSummaryName,'all_endPtFrame','all_final_endPtFrame','all_reachFrameIdx','isEndPtManuallyMarked','-append');
            
            close(h_dig2z);close(h_dig3z)
        end
        
    end
    
end
        
        